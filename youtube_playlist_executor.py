#!/usr/bin/env python3
"""
YouTube Playlist Executor

This script executes the reorganization plan generated by playlist_organizer.py
using the YouTube Data API v3.
"""

import json
import os
from datetime import datetime
from typing import Dict, List, Optional
from googleapiclient.discovery import build
from google_auth_oauthlib.flow import InstalledAppFlow
from google.auth.transport.requests import Request
from google.oauth2.credentials import Credentials
import pickle

class YouTubePlaylistExecutor:
    def __init__(self, credentials_file: str = "credentials.json"):
        self.credentials_file = credentials_file
        self.token_file = "token.pickle"
        self.scopes = ['https://www.googleapis.com/auth/youtube']
        self.youtube = None
        self.reorganization_plan = None
        
    def authenticate(self) -> bool:
        """Authenticate with YouTube Data API"""
        creds = None
        
        # Load existing token
        if os.path.exists(self.token_file):
            with open(self.token_file, 'rb') as token:
                creds = pickle.load(token)
        
        # If no valid credentials, get new ones
        if not creds or not creds.valid:
            if creds and creds.expired and creds.refresh_token:
                try:
                    creds.refresh(Request())
                except Exception as e:
                    print(f"âš ï¸ åˆ·æ–°ä»¤ç‰Œå¤±è´¥: {e}")
                    creds = None
            
            if not creds:
                if not os.path.exists(self.credentials_file):
                    print(f"âŒ æ‰¾ä¸åˆ°å‡­æ®æ–‡ä»¶: {self.credentials_file}")
                    print("è¯·ç¡®ä¿å·²ä» Google Cloud Console ä¸‹è½½ credentials.json æ–‡ä»¶")
                    return False
                
                try:
                    flow = InstalledAppFlow.from_client_secrets_file(
                        self.credentials_file, self.scopes)
                    creds = flow.run_local_server(port=0)
                except Exception as e:
                    print(f"âŒ è®¤è¯å¤±è´¥: {e}")
                    return False
            
            # Save credentials for next run
            with open(self.token_file, 'wb') as token:
                pickle.dump(creds, token)
        
        try:
            self.youtube = build('youtube', 'v3', credentials=creds)
            print("âœ… YouTube API è®¤è¯æˆåŠŸ")
            return True
        except Exception as e:
            print(f"âŒ æ„å»º YouTube æœåŠ¡å¤±è´¥: {e}")
            return False
    
    def load_reorganization_plan(self, plan_file: str = "reorganization_plan.json") -> bool:
        """Load reorganization plan"""
        try:
            with open(plan_file, 'r', encoding='utf-8') as f:
                self.reorganization_plan = json.load(f)
            print(f"âœ… æˆåŠŸåŠ è½½é‡ç»„è®¡åˆ’: {plan_file}")
            return True
        except FileNotFoundError:
            print(f"âŒ æ‰¾ä¸åˆ°é‡ç»„è®¡åˆ’æ–‡ä»¶: {plan_file}")
            return False
        except json.JSONDecodeError:
            print(f"âŒ é‡ç»„è®¡åˆ’æ–‡ä»¶æ ¼å¼é”™è¯¯: {plan_file}")
            return False
    
    def get_user_playlists(self) -> List[Dict]:
        """Get all user playlists"""
        playlists = []
        next_page_token = None
        
        while True:
            try:
                request = self.youtube.playlists().list(
                    part='snippet,status',
                    mine=True,
                    maxResults=50,
                    pageToken=next_page_token
                )
                response = request.execute()
                
                playlists.extend(response.get('items', []))
                next_page_token = response.get('nextPageToken')
                
                if not next_page_token:
                    break
                    
            except Exception as e:
                print(f"âŒ è·å–æ’­æ”¾åˆ—è¡¨å¤±è´¥: {e}")
                break
        
        return playlists
    
    def create_playlist(self, title: str, description: str = "", privacy: str = "private") -> Optional[str]:
        """Create a new playlist"""
        try:
            request = self.youtube.playlists().insert(
                part='snippet,status',
                body={
                    'snippet': {
                        'title': title,
                        'description': description
                    },
                    'status': {
                        'privacyStatus': privacy
                    }
                }
            )
            response = request.execute()
            playlist_id = response['id']
            print(f"âœ… åˆ›å»ºæ’­æ”¾åˆ—è¡¨: {title} (ID: {playlist_id})")
            return playlist_id
        except Exception as e:
            print(f"âŒ åˆ›å»ºæ’­æ”¾åˆ—è¡¨å¤±è´¥ '{title}': {e}")
            return None
    
    def update_playlist(self, playlist_id: str, title: str, description: str = "") -> bool:
        """Update playlist title and description"""
        try:
            request = self.youtube.playlists().update(
                part='snippet',
                body={
                    'id': playlist_id,
                    'snippet': {
                        'title': title,
                        'description': description
                    }
                }
            )
            request.execute()
            print(f"âœ… æ›´æ–°æ’­æ”¾åˆ—è¡¨: {title}")
            return True
        except Exception as e:
            print(f"âŒ æ›´æ–°æ’­æ”¾åˆ—è¡¨å¤±è´¥ '{title}': {e}")
            return False
    
    def delete_playlist(self, playlist_id: str) -> bool:
        """Delete a playlist"""
        try:
            request = self.youtube.playlists().delete(id=playlist_id)
            request.execute()
            print(f"âœ… åˆ é™¤æ’­æ”¾åˆ—è¡¨: {playlist_id}")
            return True
        except Exception as e:
            print(f"âŒ åˆ é™¤æ’­æ”¾åˆ—è¡¨å¤±è´¥ '{playlist_id}': {e}")
            return False
    
    def get_playlist_videos(self, playlist_id: str) -> List[Dict]:
        """Get all videos from a playlist"""
        videos = []
        next_page_token = None
        
        while True:
            try:
                request = self.youtube.playlistItems().list(
                    part='snippet',
                    playlistId=playlist_id,
                    maxResults=50,
                    pageToken=next_page_token
                )
                response = request.execute()
                
                videos.extend(response.get('items', []))
                next_page_token = response.get('nextPageToken')
                
                if not next_page_token:
                    break
                    
            except Exception as e:
                print(f"âŒ è·å–æ’­æ”¾åˆ—è¡¨è§†é¢‘å¤±è´¥ '{playlist_id}': {e}")
                break
        
        return videos
    
    def add_video_to_playlist(self, playlist_id: str, video_id: str, position: int = None) -> bool:
        """Add video to playlist"""
        try:
            body = {
                'snippet': {
                    'playlistId': playlist_id,
                    'resourceId': {
                        'kind': 'youtube#video',
                        'videoId': video_id
                    }
                }
            }
            
            if position is not None:
                body['snippet']['position'] = position
            
            request = self.youtube.playlistItems().insert(
                part='snippet',
                body=body
            )
            request.execute()
            return True
        except Exception as e:
            print(f"âŒ æ·»åŠ è§†é¢‘åˆ°æ’­æ”¾åˆ—è¡¨å¤±è´¥: {e}")
            return False
    
    def execute_rename_suggestions(self) -> bool:
        """Execute rename suggestions"""
        if not self.reorganization_plan or 'rename_suggestions' not in self.reorganization_plan:
            return True
        
        print("\nğŸ·ï¸ æ‰§è¡Œé‡å‘½åæ“ä½œ...")
        
        # Get current playlists
        current_playlists = self.get_user_playlists()
        playlist_map = {p['id']: p for p in current_playlists}
        
        for suggestion in self.reorganization_plan['rename_suggestions']:
            playlist_id = suggestion['id']
            new_name = suggestion['suggested_name']
            
            if playlist_id in playlist_map:
                if self.update_playlist(playlist_id, new_name):
                    print(f"   âœ… {suggestion['current_name']} â†’ {new_name}")
                else:
                    print(f"   âŒ é‡å‘½åå¤±è´¥: {suggestion['current_name']}")
            else:
                print(f"   âš ï¸ æ‰¾ä¸åˆ°æ’­æ”¾åˆ—è¡¨: {suggestion['current_name']}")
        
        return True
    
    def execute_delete_suggestions(self) -> bool:
        """Execute delete suggestions"""
        if not self.reorganization_plan or 'delete_suggestions' not in self.reorganization_plan:
            return True
        
        print("\nğŸ—‘ï¸ æ‰§è¡Œåˆ é™¤æ“ä½œ...")
        
        # Get current playlists
        current_playlists = self.get_user_playlists()
        playlist_map = {p['snippet']['title']: p['id'] for p in current_playlists}
        
        for suggestion in self.reorganization_plan['delete_suggestions']:
            playlist_title = suggestion['title']
            
            if playlist_title in playlist_map:
                playlist_id = playlist_map[playlist_title]
                
                # Ask for confirmation
                confirm = input(f"   ç¡®è®¤åˆ é™¤æ’­æ”¾åˆ—è¡¨ '{playlist_title}'? (y/N): ")
                if confirm.lower() == 'y':
                    if self.delete_playlist(playlist_id):
                        print(f"   âœ… å·²åˆ é™¤: {playlist_title}")
                    else:
                        print(f"   âŒ åˆ é™¤å¤±è´¥: {playlist_title}")
                else:
                    print(f"   â­ï¸ è·³è¿‡åˆ é™¤: {playlist_title}")
            else:
                print(f"   âš ï¸ æ‰¾ä¸åˆ°æ’­æ”¾åˆ—è¡¨: {playlist_title}")
        
        return True
    
    def show_execution_summary(self):
        """Show execution summary"""
        if not self.reorganization_plan:
            return
        
        print("\n" + "="*60)
        print("ğŸ“‹ æ‰§è¡Œæ‘˜è¦")
        print("="*60)
        
        print(f"\nğŸ“… è®¡åˆ’ç”Ÿæˆæ—¶é—´: {self.reorganization_plan['timestamp']}")
        print(f"ğŸ“ åŸå§‹æ’­æ”¾åˆ—è¡¨æ•°é‡: {self.reorganization_plan['original_count']}")
        
        if 'rename_suggestions' in self.reorganization_plan:
            print(f"ğŸ·ï¸ é‡å‘½åå»ºè®®: {len(self.reorganization_plan['rename_suggestions'])} ä¸ª")
        
        if 'delete_suggestions' in self.reorganization_plan:
            print(f"ğŸ—‘ï¸ åˆ é™¤å»ºè®®: {len(self.reorganization_plan['delete_suggestions'])} ä¸ª")
        
        if 'merge_suggestions' in self.reorganization_plan:
            print(f"ğŸ”„ åˆå¹¶å»ºè®®: {len(self.reorganization_plan['merge_suggestions'])} ä¸ª")
        
        print("\nğŸ’¡ æ³¨æ„: åˆå¹¶æ“ä½œéœ€è¦æ‰‹åŠ¨æ‰§è¡Œï¼Œå› ä¸ºæ¶‰åŠå¤æ‚çš„è§†é¢‘ç§»åŠ¨æ“ä½œ")
        print("å»ºè®®å…ˆæ‰§è¡Œé‡å‘½åå’Œåˆ é™¤æ“ä½œï¼Œç„¶åæ‰‹åŠ¨å¤„ç†åˆå¹¶")

def main():
    """Main function"""
    print("ğŸš€ YouTube æ’­æ”¾åˆ—è¡¨æ‰§è¡Œå™¨")
    print("=" * 50)
    
    executor = YouTubePlaylistExecutor()
    
    # Authenticate
    if not executor.authenticate():
        return
    
    # Load reorganization plan
    if not executor.load_reorganization_plan():
        return
    
    # Show summary
    executor.show_execution_summary()
    
    # Ask for confirmation
    print("\nâš ï¸ å³å°†æ‰§è¡Œæ’­æ”¾åˆ—è¡¨é‡ç»„æ“ä½œ")
    confirm = input("æ˜¯å¦ç»§ç»­? (y/N): ")
    
    if confirm.lower() != 'y':
        print("âŒ æ“ä½œå·²å–æ¶ˆ")
        return
    
    # Execute operations
    print("\nğŸ”„ å¼€å§‹æ‰§è¡Œé‡ç»„æ“ä½œ...")
    
    # Execute renames
    executor.execute_rename_suggestions()
    
    # Execute deletes
    executor.execute_delete_suggestions()
    
    print("\nâœ¨ é‡ç»„æ“ä½œå®Œæˆï¼")
    print("\nğŸ’¡ ä¸‹ä¸€æ­¥å»ºè®®:")
    print("   1. æ£€æŸ¥é‡å‘½åç»“æœ")
    print("   2. æ‰‹åŠ¨å¤„ç†åˆå¹¶å»ºè®®")
    print("   3. é‡æ–°è¿è¡Œåˆ†æä»¥éªŒè¯ç»“æœ")

if __name__ == "__main__":
    main()